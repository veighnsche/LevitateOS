# TEAM_153: Fix qcow2 Boot Hang After "Booting from Hard Disk..."

## Problem

Previous work (TEAM_152) fixed the empty qcow2 image issue. Now the qcow2 VM successfully boots and shows "Booting from Hard Disk..." but then hangs with no output.

**Symptoms:**
- SeaBIOS shows machine UUID ✅
- iPXE attempts network boot (times out) ✅
- "Booting from Hard Disk..." appears ✅
- Then: Complete silence / hang ❌

## Root Cause

### Primary Issue: Missing Console Mode in loader.conf

systemd-boot by default outputs to VGA (graphical console), NOT serial console. When systemd-boot starts, it shows the boot menu on VGA only, causing the serial console user to see nothing.

**Evidence:**
1. OVMF/SeaBIOS messages appear on serial (firmware supports serial)
2. "Booting from Hard Disk..." appears on serial (UEFI firmware still routing output to serial)
3. Then silence = systemd-boot takes over and switches to VGA only
4. User sees nothing on serial console
5. After 3 second timeout, systemd-boot boots default entry

**Why it happens:**
- `loader.conf` generated by distro-spec didn't specify `console-mode`
- Without it, systemd-boot uses default (VGA)
- Firmware hand-off is complete, so VGA becomes the output destination

### Secondary Issue: Missing Early Console Output

Even if serial console was routing correctly, the kernel needs explicit configuration to output to serial from the very start. Without `earlycon` parameter, early kernel boot messages might not appear on serial.

## Solution

### Fix 1: Enable Console Mode Preservation (Primary Fix)

**File:** `distro-spec/src/shared/boot.rs`

Changed `LoaderConfig::with_defaults()` to set `console_mode`:

```rust
// Before:
console_mode: None,

// After:
console_mode: Some(Cow::Borrowed("keep")),
```

**Effect:**
- systemd-boot respects firmware console settings (serial in our case)
- Boot menu now appears on serial console
- Boot messages route correctly to serial

**Why "keep"?**
- `"keep"` preserves firmware console settings (works with OVMF serial setup)
- Alternative values: `"auto"` (auto-detect), `"max"` (highest resolution), `"0"` (text mode 80x25)

### Fix 2: Add Early Console Output

**File:** `distro-spec/src/shared/boot.rs`

Updated kernel command line options in three places:
1. `BootEntry::with_defaults()` - for LABEL-based boot
2. `BootEntry::with_root()` - for custom root device
3. `BootEntry::set_root()` - for updating root device

Added: `earlycon=uart,io,0x3f8,115200`

**Before:**
```
root=... rw console=ttyS0,115200 console=tty0
```

**After:**
```
root=... rw earlycon=uart,io,0x3f8,115200 console=ttyS0,115200 console=tty0
```

**Effect:**
- Kernel outputs to serial from earliest possible moment (even before console drivers load)
- Full boot diagnostics visible on serial console
- Serial console line (0x3f8 = COM1) at 115200 baud

## Testing

### Test Setup

```bash
cd leviso
cargo run -- build qcow2  # Rebuild with console fixes
```

### Verification

1. **Check loader.conf:**
   ```bash
   sudo qemu-nbd --connect=/dev/nbd0 output/levitateos-x86_64.qcow2
   sudo mount /dev/nbd0p1 /mnt
   cat /mnt/loader/loader.conf | grep console-mode
   # Should show: console-mode keep
   ```

2. **Check boot entry:**
   ```bash
   cat /mnt/loader/entries/levitateos.conf
   # Should have: earlycon=uart,io,0x3f8,115200
   ```

3. **Boot test (60-second timeout):**
   ```bash
   qemu-system-x86_64 -enable-kvm -m 4G -cpu host \
     -drive if=pflash,format=raw,readonly=on,file=/usr/share/edk2/ovmf/OVMF_CODE.fd \
     -drive file=output/levitateos-x86_64.qcow2,format=qcow2,if=virtio \
     -device virtio-vga \
     -serial stdio
   ```

### Actual Test Results ✅

Boot output shows:
- systemd-boot menu appears on serial after "Booting from Hard Disk..."
- Kernel messages appear with timestamps (earlycon working)
- System reaches login prompt
- Auto-login succeeds
- Shell ready marker appears

**Full success chain:**
```
[0.000000] earlycon: uart0 at I/O port 0x3f8 (options '115200')
[0.000000] printk: legacy bootconsole [uart0] enabled
...
[    3.485529] systemd[1]: Reached target swap.target - Swaps.
[    4.679786] e1000 0000:00:02.0 eth0: (PCI:33MHz:32-bit) 52:54:00:12:34:56

LevitateOS Live - ttyS0

levitateos login: root (automatic login)

[root@levitateos ~]# ___SHELL_READY___
```

## Code Changes

### File: `distro-spec/src/shared/boot.rs`

1. **Line 81:** Added `earlycon` to default boot options (LABEL-based)
2. **Line 95:** Added `earlycon` to root device boot options
3. **Line 156:** Added `earlycon` to `set_root()` method
4. **Line 186:** Changed `console_mode: None` to `console_mode: Some(Cow::Borrowed("keep"))`

## Impact Analysis

**Affected Crates:**
- `distro-spec` - Source of truth for boot configuration
- `leviso` - ISO builder (uses distro-spec boot config)
- `tools/recstrap` - System installation tool (uses distro-spec boot config)
- All tests that boot QEMU with serial console

**Backward Compatibility:**
- ✅ LABEL-based boot still works
- ✅ PARTUUID-based boot still works
- ✅ All existing boot entry generation methods work
- ✅ Only improves serial console output

**No Breaking Changes:**
- Kernel command line is extended, not modified
- `console_mode: keep` is non-breaking (only affects console routing)
- Tests may see more output on serial (feature, not regression)

## Future Considerations

### Optional: Debug Console Output

For development/debugging, could temporarily add `systemd.log_level=debug`:

```rust
options: format!(
    "root=... rw earlycon=uart,io,0x3f8,115200 console=ttyS0,115200 console=tty0 systemd.log_level=debug",
    ...
)
```

**Not implemented yet** because:
- Default `info` level is sufficient for normal operation
- Can be added per-distro if needed
- Would increase boot log noise

### Alternative Console Modes

Could implement console mode selection per distro:

```rust
pub fn default_loader_config_with_console(mode: &str) -> LoaderConfig {
    LoaderConfig::with_defaults(OS_ID).with_console_mode(mode)
}
```

**Not implemented** because:
- `"keep"` is the right choice for all cases
- Adds unnecessary configurability
- KISS principle: one right answer

## Verification Checklist

- [x] Boot configuration generates correctly
- [x] loader.conf contains `console-mode keep`
- [x] Boot entries have correct kernel parameters
- [x] PARTUUID matches root partition
- [x] VM boots successfully with serial console
- [x] systemd-boot menu visible on serial
- [x] Kernel messages visible on serial
- [x] Login prompt appears
- [x] Auto-login works
- [x] Shell is ready

## Related Work

- **TEAM_151:** qcow2 refactoring - introduced qcow2 builder
- **TEAM_152:** Empty qcow2 fix - resolved image creation bug
- **TEAM_153 (this):** Boot hang fix - resolves console output routing

## Status

✅ **COMPLETE** - qcow2 VM boots to shell prompt with full serial console output

# =============================================================================
# RalphOS Kernel Configuration
#
# Philosophy: "QCOW2-first headless sandbox host"
# - Intended to run under QEMU/KVM as a preinstalled QCOW2 image
# - Virtio devices + vsock + serial console
# - Sandboxing primitives: namespaces/cgroups/seccomp + Landlock
# - Reduced attack surface: no WiFi/BT/audio/media/USB/input/GPU
#
# Note: This is a partial config ("fragment") that is finalized via
# `olddefconfig` during kernel build.
# =============================================================================

CONFIG_LOCALVERSION="-ralph"

# === ARCH / CPU ===
CONFIG_X86_64=y
CONFIG_SMP=y
CONFIG_NR_CPUS=256
CONFIG_PREEMPT_VOLUNTARY=y
CONFIG_HIGH_RES_TIMERS=y
CONFIG_NO_HZ_COMMON=y
CONFIG_NO_HZ_IDLE=y
CONFIG_HZ_250=y
CONFIG_HZ=250

# === INITRAMFS ===
CONFIG_BLK_DEV_INITRD=y
CONFIG_INITRAMFS_COMPRESSION_GZIP=y

# === SYSTEMD + SANDBOXING PRIMITIVES ===
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y
CONFIG_TMPFS=y
CONFIG_TMPFS_POSIX_ACL=y
CONFIG_TMPFS_XATTR=y

CONFIG_CGROUPS=y
CONFIG_CGROUP_PIDS=y
CONFIG_CGROUP_DEVICE=y
CONFIG_CPUSETS=y
CONFIG_CGROUP_CPUACCT=y
CONFIG_MEMCG=y
CONFIG_BLK_CGROUP=y
CONFIG_CGROUP_SCHED=y
CONFIG_CGROUP_BPF=y
CONFIG_CGROUP_WRITEBACK=y

CONFIG_NAMESPACES=y
CONFIG_USER_NS=y
CONFIG_PID_NS=y
CONFIG_NET_NS=y
CONFIG_UTS_NS=y
CONFIG_IPC_NS=y
CONFIG_TIME_NS=y

CONFIG_INOTIFY_USER=y
CONFIG_FANOTIFY=y
CONFIG_SIGNALFD=y
CONFIG_TIMERFD=y
CONFIG_EVENTFD=y
CONFIG_EPOLL=y
CONFIG_FHANDLE=y

CONFIG_SECCOMP=y
CONFIG_SECCOMP_FILTER=y
CONFIG_CHECKPOINT_RESTORE=y

# === MODULES ===
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
# CONFIG_MODULE_FORCE_UNLOAD is not set
CONFIG_MODVERSIONS=y
CONFIG_MODULE_COMPRESS_ZSTD=y
# CONFIG_LIVEPATCH is not set

# === STORAGE (VIRTIO-FIRST) ===
CONFIG_BLOCK=y
CONFIG_BLK_MQ_VIRTIO=y
CONFIG_BLK_DEV_LOOP=y

CONFIG_SCSI=y
CONFIG_BLK_DEV_SD=y

CONFIG_VIRTIO_BLK=y
CONFIG_VIRTIO_SCSI=y

# Device-mapper for encryption (optional but common for /var)
CONFIG_BLK_DEV_DM=y
CONFIG_DM_CRYPT=y

# === PARTITIONS ===
CONFIG_PARTITION_ADVANCED=y
CONFIG_MSDOS_PARTITION=y
CONFIG_EFI_PARTITION=y

# === FILESYSTEMS ===
CONFIG_EXT4_FS=y
CONFIG_EXT4_FS_POSIX_ACL=y
CONFIG_EXT4_FS_SECURITY=y

CONFIG_FAT_FS=y
CONFIG_VFAT_FS=y
CONFIG_FAT_DEFAULT_UTF8=y
CONFIG_NLS_CODEPAGE_437=y
CONFIG_NLS_ISO8859_1=y
CONFIG_NLS_UTF8=y

CONFIG_EROFS_FS=y
CONFIG_EROFS_FS_XATTR=y
CONFIG_EROFS_FS_POSIX_ACL=y
CONFIG_EROFS_FS_SECURITY=y
CONFIG_EROFS_FS_ZIP=y
CONFIG_EROFS_FS_ZIP_ZSTD=y

CONFIG_OVERLAY_FS=y
CONFIG_FUSE_FS=y
CONFIG_VIRTIO_FS=y

# === NETWORKING ===
CONFIG_NET=y
CONFIG_PACKET=y
CONFIG_UNIX=y
CONFIG_INET=y
CONFIG_IPV6=y
CONFIG_SYN_COOKIES=y

# Container / sandbox virtual networking
CONFIG_TUN=m
CONFIG_VETH=m
CONFIG_BRIDGE=m
CONFIG_VLAN_8021Q=m

# Firewalling (nftables)
CONFIG_NETFILTER=y
CONFIG_NF_CONNTRACK=y
CONFIG_NF_NAT=y
CONFIG_NF_TABLES=y
CONFIG_NFT_NAT=y
CONFIG_NFT_MASQ=y

# vsock for host/guest control plane channels
CONFIG_VSOCKETS=m
CONFIG_VIRTIO_VSOCKETS=m

# === VIRTIO / PCI DEVICES ===
CONFIG_PCI=y
CONFIG_VIRTIO=y
CONFIG_VIRTIO_RING=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_PCI_LEGACY=y
CONFIG_VIRTIO_NET=y
CONFIG_VIRTIO_CONSOLE=y
CONFIG_HW_RANDOM_VIRTIO=y
CONFIG_VIRTIO_BALLOON=y

# === VIRTUALIZATION (HOST) ===
CONFIG_VIRTUALIZATION=y
CONFIG_KVM=y
CONFIG_KVM_INTEL=m
CONFIG_KVM_AMD=m
CONFIG_VHOST=y
CONFIG_VHOST_NET=m
CONFIG_VHOST_VSOCK=m

# === CONSOLE (SERIAL-ONLY) ===
CONFIG_SERIAL_8250=y
CONFIG_SERIAL_8250_CONSOLE=y
CONFIG_SERIAL_8250_PCI=y

# === EFI / UEFI ===
CONFIG_EFI=y
CONFIG_EFI_STUB=y
CONFIG_EFI_VARS=y
CONFIG_EFIVAR_FS=y

# === CRYPTO (SSH, DM-CRYPT, TLS) ===
CONFIG_CRYPTO=y
CONFIG_CRYPTO_AES=y
CONFIG_CRYPTO_SHA256=y
CONFIG_CRYPTO_SHA512=y
CONFIG_CRYPTO_CHACHA20_X86_64=y
CONFIG_CRYPTO_POLY1305_X86_64=y

# === SECURITY HARDENING ===
CONFIG_SECURITY=y
CONFIG_SECURITY_NETWORK=y
CONFIG_SECURITY_PATH=y
CONFIG_SECURITY_LANDLOCK=y
CONFIG_HARDENED_USERCOPY=y
CONFIG_FORTIFY_SOURCE=y
CONFIG_STACKPROTECTOR=y
CONFIG_STACKPROTECTOR_STRONG=y
CONFIG_STRICT_KERNEL_RWX=y
CONFIG_STRICT_MODULE_RWX=y
CONFIG_RANDOMIZE_BASE=y
CONFIG_RANDOMIZE_MEMORY=y
CONFIG_AUDIT=y

# === BPF / IO ===
CONFIG_BPF=y
CONFIG_BPF_SYSCALL=y
CONFIG_IO_URING=y

# === REDUCED SURFACE AREA (EXPLICITLY DISABLED) ===
# CONFIG_WIRELESS is not set
# CONFIG_BT is not set
# CONFIG_SOUND is not set
# CONFIG_MEDIA_SUPPORT is not set
# CONFIG_USB_SUPPORT is not set
# CONFIG_INPUT is not set
# CONFIG_HID is not set
# CONFIG_DRM is not set
# CONFIG_FB is not set
# CONFIG_VGA_CONSOLE is not set
# CONFIG_FRAMEBUFFER_CONSOLE is not set
# CONFIG_ATA is not set
# CONFIG_BLK_DEV_NVME is not set
# CONFIG_MMC is not set
# CONFIG_XFS_FS is not set
# CONFIG_BTRFS_FS is not set
# CONFIG_EXFAT_FS is not set
# CONFIG_NTFS3_FS is not set
# CONFIG_SQUASHFS is not set
# CONFIG_ISO9660_FS is not set
# CONFIG_UDF_FS is not set
# CONFIG_BLK_DEV_SR is not set
# CONFIG_IPMI_HANDLER is not set
# CONFIG_EDAC is not set
# CONFIG_HWMON is not set
# CONFIG_MAGIC_SYSRQ is not set
# CONFIG_FW_LOADER_USER_HELPER is not set

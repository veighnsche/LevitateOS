name: Canary Detection

on:
  pull_request:
    branches: [master, main]
    types: [opened, synchronize, reopened]

jobs:
  detect-canary:
    name: Detect Canary Test Modifications
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Get changed files
        id: changed
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for canary modifications
        id: canary
        run: |
          CANARY_TRIGGERED=false
          CANARY_FILES=""
          for file in ${{ steps.changed.outputs.files }}; do
            if [[ -f "$file" ]] && grep -q '#\[cheat_canary' "$file" 2>/dev/null; then
              CANARY_TRIGGERED=true
              CANARY_FILES="$CANARY_FILES\n- $file"
            fi
          done
          echo "triggered=$CANARY_TRIGGERED" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CANARY_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add canary label
        if: steps.canary.outputs.triggered == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['CANARY TRIGGERED']
            });

      - name: Post canary warning comment
        if: steps.canary.outputs.triggered == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const files = `${{ steps.canary.outputs.files }}`;
            const body = `## :rotating_light: CANARY TEST TRIGGERED :rotating_light:

            This PR modifies files containing \`#[cheat_canary]\` tests:

            ${files}

            **These are honeypot tests designed to detect potential cheating.**

            This PR requires:
            1. Full audit of ALL test changes
            2. Additional reviewer approval
            3. Explicit justification for canary test modification

            ---
            *Auto-generated by canary detection workflow.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail if canary triggered
        if: steps.canary.outputs.triggered == 'true'
        run: |
          echo "::error::CANARY TESTS MODIFIED - Requires additional review"
          exit 1

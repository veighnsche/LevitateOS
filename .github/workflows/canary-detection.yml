name: Canary Detection

on:
  pull_request:
    branches: [master, main]
    types: [opened, synchronize, reopened]

jobs:
  detect-canary:
    name: Detect Canary Test Modifications
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Get changed files
        id: changed
        run: |
          # Use NUL separator to handle paths with spaces
          git diff --name-only -z ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > /tmp/changed_files.txt
          echo "count=$(wc -l < /tmp/changed_files.txt)" >> $GITHUB_OUTPUT

      - name: Check for canary modifications
        id: canary
        run: |
          CANARY_TRIGGERED=false
          CANARY_FILES=""

          # Read NUL-separated file list safely
          while IFS= read -r -d '' file || [[ -n "$file" ]]; do
            if [[ -n "$file" && -f "$file" ]] && grep -q '#\[cheat_canary' "$file" 2>/dev/null; then
              CANARY_TRIGGERED=true
              CANARY_FILES="$CANARY_FILES- \`$file\`"$'\n'
            fi
          done < /tmp/changed_files.txt

          echo "triggered=$CANARY_TRIGGERED" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CANARY_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Ensure canary label exists
        if: steps.canary.outputs.triggered == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const labelName = 'CANARY TRIGGERED';
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName
              });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: labelName,
                  color: 'ff0000',
                  description: 'PR modifies canary/honeypot tests - requires extra review'
                });
              } else {
                throw e;
              }
            }

      - name: Add canary label
        if: steps.canary.outputs.triggered == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['CANARY TRIGGERED']
            });

      - name: Check for existing canary comment
        if: steps.canary.outputs.triggered == 'true'
        id: existing_comment
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const canaryComment = comments.data.find(c =>
              c.body.includes('CANARY TEST TRIGGERED') &&
              c.user.login === 'github-actions[bot]'
            );
            return canaryComment ? 'true' : 'false';
          result-encoding: string

      - name: Post canary warning comment
        if: steps.canary.outputs.triggered == 'true' && steps.existing_comment.outputs.result != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const files = `${{ steps.canary.outputs.files }}`;
            const body = `## :rotating_light: CANARY TEST TRIGGERED :rotating_light:

            This PR modifies files containing \`#[cheat_canary]\` tests:

            ${files}

            **These are honeypot tests designed to detect potential cheating.**

            This PR requires:
            1. Full audit of ALL test changes
            2. Additional reviewer approval
            3. Explicit justification for canary test modification

            ---
            *Auto-generated by canary detection workflow.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail if canary triggered
        if: steps.canary.outputs.triggered == 'true'
        run: |
          echo "::error::CANARY TESTS MODIFIED - Requires additional review"
          exit 1
